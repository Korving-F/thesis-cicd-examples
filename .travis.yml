language: python
python:
  - "3.5"

dist: xenial

env:
  global:
    - COVERAGE_FILE="/tmp/.coverage"
    - TEST_NAME="thesis-cicd-poc"

jobs:
  include:
    - stage: build-run-test
      name: "Installing dependencies and building docker image"
      script:
        - sudo apt-get update -qy
        - sudo apt-get install -y python3-dev python3-pip
        - sudo -H pip3 install pytest pytest-cov codecov
        - docker build -t $TEST_NAME .
        - docker images
        - docker ps
        - docker run -dt -p 8282:80 -v $PWD:/tmp/ --name travisCICDContainer $TEST_NAME
        - pytest tests/

    - stage: test
      name: "Running functional tests with fixtures"
      script:
        - pytest --cov-report term --cov-branch --cov=example/ tests2/
      after_success:
        - codecov

    - stage: deploy
      name: "Simulating a deployment step"
      script:
        - echo "Deploying..."

stages:
  - build-run-test
  - test
  - name: deploy
    if: branch = master
